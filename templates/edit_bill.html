
{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Edit Bill - #{{ bill.bill_number }}</h2>
    </div>
    <div class="card-body">
        <form id="editBillForm" action="{{ url_for('update_bill', bill_id=bill.id) }}" method="POST">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="client_name" class="form-label">Client Name</label>
                    <input type="text" class="form-control" id="client_name" name="client_name" value="{{ bill.client_name }}" required>
                </div>
                <div class="col-md-6">
                    <label for="phone_number" class="form-label">Phone Number</label>
                    <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ bill.phone_number }}" required>
                </div>
            </div>

            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4>Items</h4>
                    <button type="button" class="btn btn-sm btn-primary" id="addItem">Add Item</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered" id="itemsTable">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Unit</th>
                                <th>Quantity</th>
                                <th>Price (₹)</th>
                                <th>Amount (₹)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            {% for item in bill.items %}
                            <tr>
                                <td><input type="text" class="form-control item-name" name="item_name[]" value="{{ item.name }}" required></td>
                                <td><input type="text" class="form-control" name="unit[]" value="{{ item.unit }}" required></td>
                                <td><input type="number" class="form-control item-qty" name="quantity[]" min="0.01" step="0.01" value="{{ item.quantity }}" required></td>
                                <td><input type="number" class="form-control item-price" name="price[]" min="0.01" step="0.01" value="{{ item.price }}" required></td>
                                <td><input type="number" class="form-control item-amount" name="amount[]" value="{{ item.amount }}" readonly></td>
                                <td><button type="button" class="btn btn-sm btn-danger remove-item">Remove</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="subtotal" class="form-label">Subtotal (₹)</label>
                    <input type="number" class="form-control" id="subtotal" name="subtotal" value="{{ bill.subtotal }}" readonly>
                </div>
                <div class="col-md-6">
                    <label for="total" class="form-label">Total (₹)</label>
                    <input type="number" class="form-control" id="total" name="total" value="{{ bill.total }}" readonly>
                </div>
            </div>

            <div class="text-end">
                <a href="{{ url_for('bills') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Update Bill</button>
            </div>
        </form>
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Recalculate amounts when quantity or price changes
    document.querySelectorAll('.item-qty, .item-price').forEach(function(input) {
      input.addEventListener('input', calculateAmount);
    });

    // Add item button
    document.getElementById('addItem').addEventListener('click', function() {
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" class="form-control item-name" name="item_name[]" required></td>
        <td><input type="text" class="form-control" name="unit[]" required></td>
        <td><input type="number" class="form-control item-qty" name="quantity[]" min="0.01" step="0.01" required></td>
        <td><input type="number" class="form-control item-price" name="price[]" min="0.01" step="0.01" required></td>
        <td><input type="number" class="form-control item-amount" name="amount[]" readonly></td>
        <td><button type="button" class="btn btn-sm btn-danger remove-item">Remove</button></td>
      `;
      document.getElementById('itemsBody').appendChild(newRow);
      
      // Add event listeners to new row
      newRow.querySelector('.item-qty').addEventListener('input', calculateAmount);
      newRow.querySelector('.item-price').addEventListener('input', calculateAmount);
      newRow.querySelector('.remove-item').addEventListener('click', removeItem);
    });

    // Remove item buttons
    document.querySelectorAll('.remove-item').forEach(function(button) {
      button.addEventListener('click', removeItem);
    });

    // Form submit validation
    document.getElementById('editBillForm').addEventListener('submit', function(e) {
      const rows = document.querySelectorAll('#itemsBody tr');
      if (rows.length === 0) {
        e.preventDefault();
        alert('Please add at least one item to the bill');
      }
    });

    // Calculate initial totals
    calculateTotals();
  });

  function calculateAmount(e) {
    const row = e.target.closest('tr');
    const quantity = parseFloat(row.querySelector('.item-qty').value) || 0;
    const price = parseFloat(row.querySelector('.item-price').value) || 0;
    const amount = quantity * price;
    row.querySelector('.item-amount').value = amount.toFixed(2);
    calculateTotals();
  }

  function removeItem(e) {
    const row = e.target.closest('tr');
    if (document.querySelectorAll('#itemsBody tr').length > 1) {
      row.remove();
      calculateTotals();
    } else {
      alert('Bill must have at least one item');
    }
  }

  function calculateTotals() {
    let subtotal = 0;
    document.querySelectorAll('.item-amount').forEach(function(input) {
      subtotal += parseFloat(input.value) || 0;
    });
    
    const total = subtotal; // You can add taxes or other charges here if needed
    
    document.getElementById('subtotal').value = subtotal.toFixed(2);
    document.getElementById('total').value = total.toFixed(2);
  }
</script>
{% endblock %}
{% extends "layout.html" %}

{% block content %}
<div class="card shadow">
    <div class="card-header">
        <h2><i class="bi bi-pencil-square me-2"></i>Edit Bill</h2>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('edit_bill', bill_id=bill.id) }}" id="editBillForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="client_name" class="form-label fw-bold">Client Name</label>
                    <input type="text" class="form-control" id="client_name" name="client_name" value="{{ bill.client_name }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="date" class="form-label fw-bold">Date</label>
                    <input type="date" class="form-control" id="date" name="date" value="{{ bill.date.strftime('%Y-%m-%d') if bill.date is not string else bill.date.split('T')[0] }}" required>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label for="contact" class="form-label fw-bold">Contact Number</label>
                    <input type="text" class="form-control" id="contact" name="contact" value="{{ bill.contact }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="address" class="form-label fw-bold">Address</label>
                    <input type="text" class="form-control" id="address" name="address" value="{{ bill.address }}" required>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h4 class="mb-0">Items</h4>
                </div>
                <div class="card-body">
                    <div id="items">
                        {% for item in bill.items %}
                        <div class="row item mb-3">
                            <div class="col-md-5">
                                <label class="form-label fw-bold">Description</label>
                                <input type="text" class="form-control description" name="descriptions[]" value="{{ item.description }}" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Quantity</label>
                                <input type="number" class="form-control quantity" name="quantities[]" value="{{ item.quantity }}" min="1" step="1" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Price</label>
                                <input type="number" class="form-control price" name="prices[]" value="{{ item.price }}" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Total</label>
                                <input type="number" class="form-control item-total" value="{{ item.quantity * item.price }}" readonly>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="button" class="btn btn-danger remove-item mb-2" {% if loop.index == 1 and bill.items|length == 1 %}style="display: none;"{% endif %}>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" id="addItem" class="btn btn-success mt-2">
                        <i class="bi bi-plus-circle me-1"></i> Add Item
                    </button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-dark">
                            <h4 class="mb-0">Additional Details</h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="notes" class="form-label fw-bold">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3">{{ bill.notes }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-dark">
                            <h4 class="mb-0">Payment Details</h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="subtotal" class="form-label fw-bold">Subtotal</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" id="subtotal" readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="tax" class="form-label fw-bold">GST (18%)</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" id="tax" readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="total" class="form-label fw-bold">Total</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" id="total" name="total" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-save me-1"></i> Save Changes
                </button>
                <a href="{{ url_for('bills') }}" class="btn btn-secondary btn-lg ms-2">
                    <i class="bi bi-x-circle me-1"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('items');
    const addItemButton = document.getElementById('addItem');
    
    // Calculate totals initially
    calculateItemTotals();
    updateTotals();
    
    // Add item button
    addItemButton.addEventListener('click', function() {
        const itemTemplate = `
            <div class="row item mb-3">
                <div class="col-md-5">
                    <label class="form-label fw-bold">Description</label>
                    <input type="text" class="form-control description" name="descriptions[]" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Quantity</label>
                    <input type="number" class="form-control quantity" name="quantities[]" value="1" min="1" step="1" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Price</label>
                    <input type="number" class="form-control price" name="prices[]" value="0" min="0" step="0.01" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Total</label>
                    <input type="number" class="form-control item-total" readonly>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger remove-item mb-2">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        itemsContainer.insertAdjacentHTML('beforeend', itemTemplate);
        
        // Make all remove buttons visible
        document.querySelectorAll('.remove-item').forEach(button => {
            button.style.display = 'block';
        });
        
        // Add event listeners to the new item
        addItemEventListeners(itemsContainer.lastElementChild);
    });
    
    // Add event listeners to existing items
    document.querySelectorAll('.item').forEach(item => {
        addItemEventListeners(item);
    });
    
    function addItemEventListeners(item) {
        const quantityInput = item.querySelector('.quantity');
        const priceInput = item.querySelector('.price');
        const removeButton = item.querySelector('.remove-item');
        
        quantityInput.addEventListener('change', function() {
            calculateItemTotals();
            updateTotals();
        });
        
        priceInput.addEventListener('change', function() {
            calculateItemTotals();
            updateTotals();
        });
        
        removeButton.addEventListener('click', function() {
            item.remove();
            calculateItemTotals();
            updateTotals();
            
            // Hide remove button if only one item remains
            const items = document.querySelectorAll('.item');
            if (items.length === 1) {
                items[0].querySelector('.remove-item').style.display = 'none';
            }
        });
    }
    
    function calculateItemTotals() {
        document.querySelectorAll('.item').forEach(item => {
            const quantity = parseFloat(item.querySelector('.quantity').value) || 0;
            const price = parseFloat(item.querySelector('.price').value) || 0;
            const total = quantity * price;
            item.querySelector('.item-total').value = total.toFixed(2);
        });
    }
    
    function updateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.item-total').forEach(itemTotal => {
            subtotal += parseFloat(itemTotal.value) || 0;
        });
        
        const tax = subtotal * 0.18;
        const total = subtotal + tax;
        
        document.getElementById('subtotal').value = subtotal.toFixed(2);
        document.getElementById('tax').value = tax.toFixed(2);
        document.getElementById('total').value = total.toFixed(2);
    }
});
</script>
{% endblock %}
